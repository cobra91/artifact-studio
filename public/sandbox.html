<!doctype html>
<html lang="en">
  <head>
    <title>Sandbox</title>
    <script src="/sandbox-libs/react.production.min.js"></script>
    <script src="/sandbox-libs/react-dom.production.min.js"></script>
    <script src="/sandbox-libs/babel.min.js"></script>
    <script src="/sandbox-libs/vue.global.prod.js"></script>
    <script src="/sandbox-libs/svelte.compiler.js"></script>
    <!-- Tailwind CSS will be processed locally -->
    <link rel="stylesheet" href="/sandbox-libs/tailwind.css">
  </head>
  <body>
    <div id="root"></div>
    <script type="text/javascript">
      const renderers = {
        react: (code) => {
          try {
            const transformedCode = Babel.transform(code, {
              presets: ["react"],
            }).code;
            const Component = new Function(
              "React",
              "useState",
              "useEffect",
              `return (${transformedCode})`
            )(React, React.useState, React.useEffect);
            const root = ReactDOM.createRoot(document.getElementById("root"));
            root.render(React.createElement(Component));
          } catch (error) {
            console.error("Error in React renderer:", error);
            throw error;
          }
        },
        vue: (code) => {
          const { createApp } = Vue;
          const template = code.match(/<template>([\s\S]*)<\/template>/)[1];
          const scriptContent = code.match(/<script.*>([\s\S]*)<\/script>/)[1];
          const app = createApp({
            template,
            setup() {
              const { ref, onMounted } = Vue;
              let setupCode = new Function("ref", "onMounted", scriptContent);
              return setupCode(ref, onMounted);
            },
          });
          app.mount("#root");
        },
        svelte: (code) => {
          const { code: jsCode } = svelte.compile(code);
          const Component = new Function(jsCode + "\nreturn Component;")();
          new Component({ target: document.getElementById("root") });
        },
      };

      window.addEventListener("message", (event) => {
        const { type, payload } = event.data;
        if (type === "render-component") {
          try {
            const { framework, code } = payload;
            if (renderers[framework]) {
              renderers[framework](code);
              window.parent.postMessage(
                { type: "render-component", payload: { success: true } },
                "*",
              );
            } else {
              throw new Error(`Unsupported framework: ${framework}`);
            }
          } catch (error) {
            console.error("Error rendering component:", error);
            window.parent.postMessage(
              { type: "error", payload: { error: error.message } },
              "*",
            );
          }
        }
      });

      // Notify the parent window that the sandbox is ready
      window.parent.postMessage({ type: "sandbox-ready" }, "*");
    </script>
  </body>
</html>
